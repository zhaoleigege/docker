
<!DOCTYPE html>
<html>
  <!-- OriginalSrc: http://www.smartjava.org/content/service-discovery-docker-and-consul-part-1/#conclusions -->
  <head>
    <meta http-equiv="Content-Type" content="text/html"; charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Service Discovery with Docker and Consul: part 1 - SmartJava</title>
    
<link rel="stylesheet" href="assets/1548666470-a4d321069f965e7ece6e5c11ca952e3e.css">
<style>
svg:not(:root).svg-inline--fa{overflow:visible}.svg-inline--fa{display:inline-block;font-size:inherit;height:1em;overflow:visible;vertical-align:-.125em}.svg-inline--fa.fa-lg{vertical-align:-.225em}.svg-inline--fa.fa-w-1{width:.0625em}.svg-inline--fa.fa-w-2{width:.125em}.svg-inline--fa.fa-w-3{width:.1875em}.svg-inline--fa.fa-w-4{width:.25em}.svg-inline--fa.fa-w-5{width:.3125em}.svg-inline--fa.fa-w-6{width:.375em}.svg-inline--fa.fa-w-7{width:.4375em}.svg-inline--fa.fa-w-8{width:.5em}.svg-inline--fa.fa-w-9{width:.5625em}.svg-inline--fa.fa-w-10{width:.625em}.svg-inline--fa.fa-w-11{width:.6875em}.svg-inline--fa.fa-w-12{width:.75em}.svg-inline--fa.fa-w-13{width:.8125em}.svg-inline--fa.fa-w-14{width:.875em}.svg-inline--fa.fa-w-15{width:.9375em}.svg-inline--fa.fa-w-16{width:1em}.svg-inline--fa.fa-w-17{width:1.0625em}.svg-inline--fa.fa-w-18{width:1.125em}.svg-inline--fa.fa-w-19{width:1.1875em}.svg-inline--fa.fa-w-20{width:1.25em}.svg-inline--fa.fa-pull-left{margin-right:.3em;width:auto}.svg-inline--fa.fa-pull-right{margin-left:.3em;width:auto}.svg-inline--fa.fa-border{height:1.5em}.svg-inline--fa.fa-li{width:2em}.svg-inline--fa.fa-fw{width:1.25em}.fa-layers svg.svg-inline--fa{bottom:0;left:0;margin:auto;position:absolute;right:0;top:0}.fa-layers{display:inline-block;height:1em;position:relative;text-align:center;vertical-align:-.125em;width:1em}.fa-layers svg.svg-inline--fa{-webkit-transform-origin:center center;transform-origin:center center}.fa-layers-counter,.fa-layers-text{display:inline-block;position:absolute;text-align:center}.fa-layers-text{left:50%;top:50%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);-webkit-transform-origin:center center;transform-origin:center center}.fa-layers-counter{background-color:#ff253a;border-radius:1em;-webkit-box-sizing:border-box;box-sizing:border-box;color:#fff;height:1.5em;line-height:1;max-width:5em;min-width:1.5em;overflow:hidden;padding:.25em;right:0;text-overflow:ellipsis;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top right;transform-origin:top right}.fa-layers-bottom-right{bottom:0;right:0;top:auto;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:bottom right;transform-origin:bottom right}.fa-layers-bottom-left{bottom:0;left:0;right:auto;top:auto;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:bottom left;transform-origin:bottom left}.fa-layers-top-right{right:0;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top right;transform-origin:top right}.fa-layers-top-left{left:0;right:auto;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top left;transform-origin:top left}.fa-lg{font-size:1.33333em;line-height:.75em;vertical-align:-.0667em}.fa-xs{font-size:.75em}.fa-sm{font-size:.875em}.fa-1x{font-size:1em}.fa-2x{font-size:2em}.fa-3x{font-size:3em}.fa-4x{font-size:4em}.fa-5x{font-size:5em}.fa-6x{font-size:6em}.fa-7x{font-size:7em}.fa-8x{font-size:8em}.fa-9x{font-size:9em}.fa-10x{font-size:10em}.fa-fw{text-align:center;width:1.25em}.fa-ul{list-style-type:none;margin-left:2.5em;padding-left:0}.fa-ul>li{position:relative}.fa-li{left:-2em;position:absolute;text-align:center;width:2em;line-height:inherit}.fa-border{border:solid .08em #eee;border-radius:.1em;padding:.2em .25em .15em}.fa-pull-left{float:left}.fa-pull-right{float:right}.fa.fa-pull-left,.fab.fa-pull-left,.fal.fa-pull-left,.far.fa-pull-left,.fas.fa-pull-left{margin-right:.3em}.fa.fa-pull-right,.fab.fa-pull-right,.fal.fa-pull-right,.far.fa-pull-right,.fas.fa-pull-right{margin-left:.3em}.fa-spin{-webkit-animation:fa-spin 2s infinite linear;animation:fa-spin 2s infinite linear}.fa-pulse{-webkit-animation:fa-spin 1s infinite steps(8);animation:fa-spin 1s infinite steps(8)}@-webkit-keyframes fa-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes fa-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}.fa-rotate-90{-webkit-transform:rotate(90deg);transform:rotate(90deg)}.fa-rotate-180{-webkit-transform:rotate(180deg);transform:rotate(180deg)}.fa-rotate-270{-webkit-transform:rotate(270deg);transform:rotate(270deg)}.fa-flip-horizontal{-webkit-transform:scale(-1,1);transform:scale(-1,1)}.fa-flip-vertical{-webkit-transform:scale(1,-1);transform:scale(1,-1)}.fa-flip-horizontal.fa-flip-vertical{-webkit-transform:scale(-1,-1);transform:scale(-1,-1)}:root .fa-flip-horizontal,:root .fa-flip-vertical,:root .fa-rotate-180,:root .fa-rotate-270,:root .fa-rotate-90{-webkit-filter:none;filter:none}.fa-stack{display:inline-block;height:2em;position:relative;width:2.5em}.fa-stack-1x,.fa-stack-2x{bottom:0;left:0;margin:auto;position:absolute;right:0;top:0}.svg-inline--fa.fa-stack-1x{height:1em;width:1.25em}.svg-inline--fa.fa-stack-2x{height:2em;width:2.5em}.fa-inverse{color:#fff}.sr-only{border:0;clip:rect(0,0,0,0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.sr-only-focusable:active,.sr-only-focusable:focus{clip:auto;height:auto;margin:0;overflow:visible;position:static;width:auto}
</style>
<style>

</style>
<style>
@media print {#ghostery-purple-box {display:none !important}}
</style>
<style>
.fluid-width-video-wrapper{width:100%;position:relative;padding:0;}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper object,.fluid-width-video-wrapper embed {position:absolute;top:0;left:0;width:100%;height:100%;}
</style>
<style>
object,embed{                -webkit-animation-duration:.001s;-webkit-animation-name:playerInserted;                -ms-animation-duration:.001s;-ms-animation-name:playerInserted;                -o-animation-duration:.001s;-o-animation-name:playerInserted;                animation-duration:.001s;animation-name:playerInserted;}                @-webkit-keyframes playerInserted{from{opacity:0.99;}to{opacity:1;}}                @-ms-keyframes playerInserted{from{opacity:0.99;}to{opacity:1;}}                @-o-keyframes playerInserted{from{opacity:0.99;}to{opacity:1;}}                @keyframes playerInserted{from{opacity:0.99;}to{opacity:1;}}
</style>

    <style class="mx-wc-style">
      .mx-wc-main img {max-width: 100%;}
      .mx-wc-main{
        box-sizing: content-box;
        background-color: rgb(37, 42, 52) !important;
        margin: 0 auto;
        max-width: 1048px;
        padding: 15px 15px 80px 15px;
      }

      .mx-wc-main > .clipping-information{
        text-align: left;
        margin-top: 20px;
        background-color: #eeeeee !important;
        padding: 15px;
        border-radius: 4px;
        color: #333;
        font-size: 14px !important;
        line-height: 22px !important;
      }
      .mx-wc-main > .clipping-information a {
        color: blue !important;
        text-decoration: underline !important;
      }
      .mx-wc-main > .clipping-information label {
        display: inline;
        text-transform: none;
      }
      .mx-wc-main > .clipping-information label > code {
        padding: 2px 8px;
        background-color: rgba(200, 200, 200, 0.7)!important;
        font-size: 14px;
      }

    </style>
  </head>
  <body style="background-color: #ffffff !important; min-height: 100%; height: auto;" id="" class="layout--single">
    <div class="mx-wc-main">
      <DIV class="initial-content" style="display: block; float: none; position: relative; top: 0; left: 0; border: 0px; width: 100%; min-width:100%; max-width: 100%; min-height: auto; max-height: 100%; height: auto; padding: 0px; margin: 0px;"><DIV id="main" role="main" style="display: block; float: none; position: relative; top: 0; left: 0; border: 0px; width: 100%; min-width:100%; max-width: 100%; min-height: auto; max-height: 100%; height: auto; padding: 0px; margin: 0px;"><article class="page mx-wc-selected-elem" itemscope="" itemtype="http://schema.org/CreativeWork" style="float: none; position: relative; top: 0px; left: 0px; margin: 0px; flex: unset; width: 100%; max-width: 100%; box-sizing: border-box;">
    
    
    
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Service Discovery with Docker and Consul: part 1
</h1>
          
            <p class="page__meta">
              <svg class="svg-inline--fa fa-calendar fa-w-14 fa-fw" aria-hidden="true" data-prefix="fa" data-icon="calendar" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M12 192h424c6.6 0 12 5.4 12 12v260c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V204c0-6.6 5.4-12 12-12zm436-44v-36c0-26.5-21.5-48-48-48h-48V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H160V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H48C21.5 64 0 85.5 0 112v36c0 6.6 5.4 12 12 12h424c6.6 0 12-5.4 12-12z"></path></svg><!-- <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> --> <time datetime="2016-04-23T00:00:00+02:00">April 23, 2016 </time>
              <svg class="svg-inline--fa fa-clock fa-w-16" aria-hidden="true" data-prefix="far" data-icon="clock" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"></path></svg><!-- <i class="far fa-clock" aria-hidden="true"></i> --> 




  14 minute read

            </p>
          
        
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><svg class="svg-inline--fa fa-file-alt fa-w-12" aria-hidden="true" data-prefix="fas" data-icon="file-alt" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" data-fa-i2svg=""><path fill="currentColor" d="M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm64 236c0 6.6-5.4 12-12 12H108c-6.6 0-12-5.4-12-12v-8c0-6.6 5.4-12 12-12h168c6.6 0 12 5.4 12 12v8zm0-64c0 6.6-5.4 12-12 12H108c-6.6 0-12-5.4-12-12v-8c0-6.6 5.4-12 12-12h168c6.6 0 12 5.4 12 12v8zm0-72v8c0 6.6-5.4 12-12 12H108c-6.6 0-12-5.4-12-12v-8c0-6.6 5.4-12 12-12h168c6.6 0 12 5.4 12 12zm96-114.1v6.1H256V0h6.1c6.4 0 12.5 2.5 17 7l97.9 98c4.5 4.5 7 10.6 7 16.9z"></path></svg><!-- <i class="fas fa-file-alt"></i> --> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="http://www.smartjava.org/content/service-discovery-docker-and-consul-part-1/#">Getting started</a>
    <ul>
      <li><a href="http://www.smartjava.org/content/service-discovery-docker-and-consul-part-1/#">Creating the docker-machines</a></li>
      <li><a href="http://www.smartjava.org/content/service-discovery-docker-and-consul-part-1/#">Start the main consul machine</a></li>
      <li><a href="http://www.smartjava.org/content/service-discovery-docker-and-consul-part-1/#">Setup docker swarm</a></li>
      <li><a href="http://www.smartjava.org/content/service-discovery-docker-and-consul-part-1/#">Setup the docker network</a></li>
      <li><a href="http://www.smartjava.org/content/service-discovery-docker-and-consul-part-1/#">Start the consul agents</a></li>
    </ul>
  </li>
  <li><a href="http://www.smartjava.org/content/service-discovery-docker-and-consul-part-1/#">Adding the services</a>
    <ul>
      <li><a href="http://www.smartjava.org/content/service-discovery-docker-and-consul-part-1/#">Service registration</a></li>
      <li><a href="http://www.smartjava.org/content/service-discovery-docker-and-consul-part-1/#">Service discovery</a></li>
    </ul>
  </li>
  <li><a href="http://www.smartjava.org/content/service-discovery-docker-and-consul-part-1/#">Conclusions</a></li>
</ul>
            </nav>
          </aside>
        
        <p>During the last year I've become a big fan of using Consul for all things related to service discovery. If you're doing microservices you've probably ran into the issue that when the number of services you create increases it becomes more and more difficult to manage the communication between all these services. Consul provides a perfect fit for this problem. It provides an easy to use, open standards based (opinionated) approach to service discovery (and besides that provides a large set of other functions). I recently gave a presentation on how to do <a href="http://www.slideshare.net/josdirksen/service-discovery-in-a-microservice-architecture-using-consul">Service discovery in a microservices architecture using Consul</a>, and got a couple of requests to explain a bit more about it. So in this article, and a couple of follow ups, I'll explain a bit more about how you can use Consul. I won't just focus on purely the service discovery part provided by Consul, but also show you a couple of other features provided by either Consul or one of the tools surrounding it. 

</p><p>For the other articles in this series you can look here:</p>
<ol>
  <li><a href="http://www.smartjava.org/content/presentation-service-discovery-microservice-architecture">Presentation on Service discovery with consul</a></li>
  <li><a href="http://www.smartjava.org/content/service-discovery-docker-and-consul-part-2">Service discover with Docker and Consul: Part 2</a></li>
</ol>

Note that all the samples, docker files, etc. can be found in the following repo: <a href="https://github.com/josdirksen/next-build-consul">https://github.com/josdirksen/next-build-consul</a>. So instead of "copy &amp; pasting" from this article just clone the repository.<p></p>
<h2><a href="#getting-started" name="getting-started">Getting started</a></h2>
<p>In this first article we'll create a simple docker based architecture with a number of services that will communicate with one another using simple HTTP calls, and that will discover each other using Consul. Our initial target architecture looks a bit like this:</p>

<p><img src="assets/1548666470-8b48ca1a0e671144aba591d8b286ce97.png" width="542" height="386" alt="demo1.png"></p>

<p>To accomplish all this we first need to take the following steps to set up an environment we can run the services in:</p>
<p><strong>Note:</strong> I'm using docker-machine on my Mac to do all this. If you run Windows or Linux the commands might vary slightly. Let's hope that Docker for Mac (and Windows) quickly comes out of beta (<a href="https://blog.docker.com/2016/03/docker-for-mac-windows-beta/)">https://blog.docker.com/2016/03/docker-for-mac-windows-beta)</a>, so we don't need this anymore...</p>
<ol>
  <li><strong>Create four docker-machines:</strong> One in which we'll run a Consul server, and three in which we'll run our individual services and a Consul agent.</li>
  <li><strong>Start main consul server:</strong> We'll use a single Consul server (and multiple Consul agents, more on that later) to keep track of the running services and some docker related stuff.</li>
  <li><strong>Setup docker swarm:</strong> To avoid having to deploy our services individually we'll use a Docker Swarm to manager the three nodes on which we'll run our services. In the rest of this article we'll use docker-compose to start and stop the individual services.</li>
  <li><strong>Setup docker overlay network:</strong> If we want to have our services communicate with each other in a simple manner, we will create an overlay network. This will allow the components we deploy to docker to easily communicate with one other (since they'll share the same subnet)</li>
  <li><strong>Start the Consul agents:</strong> Each node will have its own consul agent, which will monitor the health of the services on that node and communicate with the consul server.</li>
</ol>
<h3><a href="#creating-the-docker-machines" name="creating-the-docker-machines">Creating the docker-machines</a></h3>
<p>So the first thing we'll do is create some docker-machines. First we'll create the docker-machine that'll hold our consul server. The reason we run this one first, is so that we can point the other docker-machines to consul running inside this container and use it for managing docker-swarm and the overlay network we want to use.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
docker-machine create nb-consul --driver virtualbox

</code></pre></div></div>

<p>Before we start the Consul server, lets quickly look at the architecture behind Consul.</p>

<p><img src="assets/1548666470-1d4f4921b36612ca27f88a87afb31d39.png" width="604" height="496" alt="consul-arch.png"></p>

<p>In this image you can see the two modes Consul can run in. It can run in Server mode or Agent mode. All the Servers talk to each other and decide who is the leader. An agent just talks to one of the servers and normally runs on the node that is also running the services. Note that the state between all the Servers and Agents within a cluster is shared. So when a service registers itself with one of the agents, that information is available to all the Servers and the Agents that are connected to one another.</p>
<p>For this set of articles we won't setup a cluster of Servers, but just use one. Now that we've got our docker-machine running, we can start the consul server. Before we start let me first show you a simple script that make switching between different docker-machines easier and the alias we use to avoid typing "docker-machine".</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
# quickly switch environments e.g: . dm-env nb-consul
$ cat ~/bin/dm-env
eval `docker-machine env $2 $1`

# avoid typing too much
$ alias dm
dm=docker-machine

</code></pre></div></div>

<p>So with these aliases in place, first we do a "dm-env nb-consul" to select the correct docker-machine.</p>
<h3><a href="#start-the-main-consul-machine" name="start-the-main-consul-machine">Start the main consul machine</a></h3>
<p>Next we get the ip address of this server and then we can start our Consul server like this.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
# get the ip address
$
192.168.99.106

# use this ip address in the advertise
docker run -d --restart always -p 8300:8300 -p 8301:8301 -p 8301:8301/udp -p 8302:8302/udp \ 
           -p 8302:8302 -p 8400:8400 -p 8500:8500 -p 53:53/udp -h server1 progrium/consul \
           -server -bootstrap -ui-dir /ui -advertise $(dm ip nb-consul)

</code></pre></div></div>

<p>At this point we have our docker consul server running. Now lets create the other three servers on which we'll run our services.</p>
<h3><a href="#setup-docker-swarm" name="setup-docker-swarm">Setup docker swarm</a></h3>
<p>As you can see in the following commands, we're also creating a docker swarm cluster at the same time, and the "nb1" node is the swarm master.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
docker-machine create -d virtualbox --swarm --swarm-master \ 
           --swarm-discovery="consul://$(docker-machine ip nb-consul):8500" \
           --engine-opt="cluster-store=consul://$(docker-machine ip nb-consul):8500" \
           --engine-opt="cluster-advertise=eth1:2376" nb1

docker-machine create -d virtualbox --swarm  \
            --swarm-discovery="consul://$(docker-machine ip nb-consul):8500" \
            --engine-opt="cluster-store=consul://$(docker-machine ip nb-consul):8500" \
           --engine-opt="cluster-advertise=eth1:2376" nb2

docker-machine create -d virtualbox --swarm \
              --swarm-discovery="consul://$(docker-machine ip nb-consul):8500"  \
              --engine-opt="cluster-store=consul://$(docker-machine ip nb-consul):8500" \
              --engine-opt="cluster-advertise=eth1:2376" nb3

</code></pre></div></div>

<p>At this point we've got four docker-machines up and running. One is running a Consul master, and the other ones aren't doing much yet.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dm ls
NAME        ACTIVE   DRIVER       STATE     URL                         SWARM
nb1         -        virtualbox   Running   tcp://192.168.99.110:2376   nb1 (master)
nb2         -        virtualbox   Running   tcp://192.168.99.111:2376   nb1
nb3         -        virtualbox   Running   tcp://192.168.99.112:2376   nb1
nb-consul   *        virtualbox   Running   tcp://192.168.99.106:2376

</code></pre></div></div>

<p>Before we continue with configuring the slaves, there is one more utility script that might come in handy:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat addToHost
#!/usr/bin/env bash

$ cat addToHost
#!/usr/bin/env bash

update-docker-host(){
	# clear existing docker.local entry from /etc/hosts
	sudo sed -i "/[[:space:]]"${1}"\.local$/d" /etc/hosts

	# get ip of running machine
	export DOCKER_IP="$(docker-machine ip $1)"

	# update /etc/hosts with docker machine ip
	[[ -n $DOCKER_IP ]] &amp;&amp; sudo /bin/bash -c "echo \"${DOCKER_IP} $1.local\" &gt;&gt; /etc/hosts"
}

update-docker-host nb1
update-docker-host nb2
update-docker-host nb3
update-docker-host nb-consul

</code></pre></div></div>

<p>This script adds the ip addresses of the docker-machines to your local "hosts" file. This means that we can simply access the docker hosts by just going to "http://nb-consul.local:8500" for instance.</p>

<h3><a href="#setup-the-docker-network" name="setup-the-docker-network">Setup the docker network</a></h3>

<p>In our scenario we want all our services to be able to communicate with one another. We have multiple docker hosts so we need to find an easy way to have services running in node "nb1" to be able to communicate with "nb2". The easiest way to accomplish this is to create a single network that is used by all the services running in the docker containers. To do this we create a simple "overlay" network like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># select the swarm master
$ dm-env nb1 --swarm
# create an overlay network the the name my-net
$ docker network create --driver overlay --subnet=10.0.9.0/24 my-net

</code></pre></div></div>

<p>And since we created this on our swarm master, this network will be available in all the members of our swarm. When we create our services later on, we'll connect those to this network, so that they all share the same subnet.</p>
<h3><a href="#start-the-consul-agents" name="start-the-consul-agents">Start the consul agents</a></h3>
<p>To start the consul agents, we're going to use docker-compose. The docker-compose file is very straightforward, and is just a simple way to avoid typing in all the launch commands (especially when you're doing live demos)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: '2'

services:
  agent-1:
    image: progrium/consul
    container_name: consul_agent_1
    ports:
      - 8300:8300
      - 8301:8301
      - 8301:8301/udp
      - 8302:8302
      - 8302:8302/udp
      - 8400:8400
      - 8500:8500
      - 53:53/udp
    environment:
      - "constraint:node==nb1"
    command: -ui-dir /ui -join 192.168.99.106 -advertise 192.168.99.110
    networks:
      default:
        aliases:
          - agent-1

  agent-2:
    image: progrium/consul
    container_name: consul_agent_2
    ports:
      - 8300:8300
      - 8301:8301
      - 8301:8301/udp
      - 8302:8302
      - 8302:8302/udp
      - 8400:8400
      - 8500:8500
      - 53:53/udp
    environment:
      - "constraint:node==nb2"
    command: -ui-dir /ui -join 192.168.99.106 -advertise 192.168.99.111
    networks:
      default:
        aliases:
          - agent-2

  agent-3:
    image: progrium/consul
    container_name: consul_agent_3
    ports:
      - 8300:8300
      - 8301:8301
      - 8301:8301/udp
      - 8302:8302
      - 8302:8302/udp
      - 8400:8400
      - 8500:8500
      - 53:53/udp
    environment:
      - "constraint:node==nb3"
    command: -ui-dir /ui -join 192.168.99.106 -advertise 192.168.99.112
    networks:
      default:
        aliases:
          - agent-3

networks:
  default:
    external:
      name: my-net

</code></pre></div></div>

<p>Nothing to special in this file. The only thing you might notice it that we use explicit IP addresses in the commands to start the Consul agents. We could, easily, just use an environment variable for this, which is set through a simple bash script. But for this article we just specify the IP addresses of the relevant docker-machines. Make sure your "DOCKER_HOST" points to the docker swarm master and start the agents like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># start the agents
$ docker-compose -f docker-compose-agents.yml up -d
Creating consul_agent_3
Creating consul_agent_2
Creating consul_agent_1

# check what is running
$ docker ps  --format '\t\t\t'

bf2000882dcc	progrium/consul	"/bin/start -ui-dir /"	nb1/consul_agent_1
a1bc26eef516	progrium/consul	"/bin/start -ui-dir /"	nb2/consul_agent_2
eb0d1c0cc075	progrium/consul	"/bin/start -ui-dir /"	nb3/consul_agent_3

</code></pre></div></div>

<p>At this point we have a Consul server running in docker-machine "nb-consul" and we've got three agents running on our nodes. To validate our setup, let's open up the Consul server's interface: <a href="http://nb-consul.local:8500/">http://nb-consul.local:8500</a></p>

<p><img src="assets/1548666470-4256cf6fb42149fd80f66c4e0583a362.png" width="700" alt="consul_1.png"></p>

<p>And, as you can see, we've got 1 server running (our Consul Server), and the three agents. So at this point we can start adding our services, to get to this architecture:</p>

<p><img src="assets/1548666470-8b48ca1a0e671144aba591d8b286ce97.png" width="542" height="386" alt="demo1.png"></p>

<h2><a href="#adding-the-services" name="adding-the-services">Adding the services</a></h2>
<p>The services in this case are just simple golang applications. I created a simple application that can run in frontend or in backend mode. In frontend mode it provides a minimal UI with a button to call a backend service, and in backend mode it provides a simple API that returns some information to the calling party, and it provides a simple UI showing some statistics. For convenience I've pushed this image to the docker hub (<a href="https://hub.docker.com/r/josdirksen/demo-service/">https://hub.docker.com/r/josdirksen/demo-service/</a>) so you can easily use it without having to build from the source github repository.</p>
<p>As you can see in the previous architecture overview we want to start a frontend and a backend service on each of the nodes. We could do this manually, but since we've got docker-swarm we can easily do this through a single docker-compose file. If you want to see what this file looks like you can check the sources here (<a href="https://github.com/josdirksen/next-build-consul)">https://github.com/josdirksen/next-build-consul)</a>.<br>
Lets first launch the services, and then we'll look at how they register themselves with Consul:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># make sure you select the swarm master
$ . dm-env nb1 --swarm

# now use docker-compose to run the backend services
$ docker-compose -f docker-compose-backend.yml up -d
Creating Backend2
Creating Backend3
Creating Backend1

# and use docker-compose to run the frontend services
$ docker-compose -f docker-compose-frontend.yml up -d
Creating Frontend1
Creating Frontend3
Creating Frontend2

# check in docker if everything is running
$ docker ps --format '\t\t\t'

65846be2e367    josdirksen/demo-service "/entrypoint.sh --typ"  nb2/Frontend2
aedd80ab0889    josdirksen/demo-service "/entrypoint.sh --typ"  nb3/Frontend3
d9c3b1d83b5e    josdirksen/demo-service "/entrypoint.sh --typ"  nb1/Frontend1
7c860403b257    josdirksen/demo-service "/entrypoint.sh --typ"  nb1/Backend1
80632e910d33    josdirksen/demo-service "/entrypoint.sh --typ"  nb3/Backend3
534da0670e13    josdirksen/demo-service "/entrypoint.sh --typ"  nb2/Backend2
bf2000882dcc    progrium/consul "/bin/start -ui-dir /"  nb1/consul_agent_1
a1bc26eef516    progrium/consul "/bin/start -ui-dir /"  nb2/consul_agent_2
eb0d1c0cc075    progrium/consul "/bin/start -ui-dir /"  nb3/consul_agent_3

</code></pre></div></div>

<p>As you can see in the last output of "docker ps" we have three frontends, three backends, and three consul agents running. This is pretty much the architecute we're aiming for. We can also see this when we open up Consul:</p>

<p><img src="assets/1548666470-f82b8f84fef25b0cee694979b73e9555.png" width="700" alt="consul_2.png"></p>

<p>As you can see we've got three frontend services and three backend services registered in Consul. If we open one of the backends we'll see some general information:</p>

<p><img src="assets/1548666470-71e634a67c2565c5d165c9d35e154030.png" width="700" alt="backend_1.png"></p>

<p>And we can use the frontend UI, to call one of our backends:</p>

<p><img src="assets/1548666470-fe89112cfc905a037df4d775cb03f6af.png" width="700" alt="frontend_1.png"></p>

<p>There are however a couple of questions we need to answer:</p>
<ol>
  <li><strong>Service registration</strong>: When we start a backend or frontend service, we see it appearing in Consul. How do we do this?</li>
  <li><strong>Service discovery</strong>: And when we click the button on the frontend service a call is made to one of the backend services. How does the frontend know which service to call?</li>
</ol>
<p>In the next sections we'll look a bit closer at these questions.</p>
<h3><a href="#service-registration" name="service-registration">Service registration</a></h3>
<p>First off, service registration. To register a service with Consul, we have to make a very simple REST call to our local consul-agent, which looks something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "Name": "service1",
  "address": "10.0.0.12",
  "port": 8080,
  "Check": {
     "http": "http://10.0.0.12:8080/health",
     "interval": "5s"
  }
}

</code></pre></div></div>

<p>As you can see, we specify the name, address and port where the service can be found, and we add an additional health check. When the healtcheck returns something in the 200 range the service is marked as healthy and can be discoverd by other services. So how do we do this for our services. If you look at the sources for this example you can find the "script/entrypoint.sh" file, which looks like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

<span class="nv">IP</span><span class="o">=</span><span class="sb">`</span>ip addr | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'eth0.*state UP'</span> <span class="nt">-A2</span> | <span class="nb">tail</span> <span class="nt">-n</span> 1 | <span class="nb">awk</span> <span class="s1">'{print $2}'</span> | <span class="nb">cut</span> <span class="nt">-f1</span> <span class="nt">-d</span> <span class="s1">'/'</span><span class="sb">`</span>
<span class="nv">NAME</span><span class="o">=</span><span class="s2">"</span><span class="nv">$2</span><span class="s2">-service"</span>

<span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> MSG &amp;lt<span class="p">;</span>&amp;lt<span class="p">;</span> EOM
<span class="o">{</span>
  <span class="s2">"Name"</span>: <span class="s2">"</span><span class="nv">$NAME</span><span class="s2">"</span>,
  <span class="s2">"address"</span>: <span class="s2">"</span><span class="nv">$IP</span><span class="s2">"</span>,
  <span class="s2">"port"</span>: <span class="nv">$PORT</span>,
  <span class="s2">"Check"</span>: <span class="o">{</span>
     <span class="s2">"http"</span>: <span class="s2">"http://</span><span class="nv">$IP</span><span class="s2">:</span><span class="nv">$PORT</span><span class="s2">"</span>,
     <span class="s2">"interval"</span>: <span class="s2">"5s"</span>
  <span class="o">}</span>
<span class="o">}</span>
EOM

curl <span class="nt">-v</span> <span class="nt">-XPUT</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$MSG</span><span class="s2">"</span> http://consul_agent_<span class="nv">$SERVER_ID</span>:8500/v1/agent/service/register &amp;amp<span class="p">;</span>&amp;amp<span class="p">;</span> /app/main <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>

</code></pre></div></div>

<p>What this script does, it that it creates the JSON to be sent to the consul-agent and before starting the main application it uses "curl" to send it. So when a service is started, it automatically registers itself to the local consul agent (note that you can also do this more automatically for instance using <a href="http://www.smartjava.org/content/service-discovery-docker-and-consul-part-1/d">Consul Registrator</a>. This works since we can just reference the local agent by its name, since it is in the same contaner. If you look closely you might see that we use a couple of environment variables here. These are passed in through the docker-compose file we use:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
frontend-1:
    image: josdirksen/demo-service
    container_name: Frontend1
    ports:
      - 8090:8090
    environment:
      - "constraint:node==nb1"
      - SERVER_ID=1
      - SERVERNAME=Server1
      - PORT=8090
    command: /entrypoint.sh --type frontend
    dns: 192.168.99.106
    dns_search: service.consul
...

</code></pre></div></div>

<p>The interesting part here are the DNS entries. As you might remember the 192.168.99.106 is the address of our consul server. This means that we do DNS lookups against Consul (we could also have pointed to a consul agent).</p>
<h3><a href="#service-discovery" name="service-discovery">Service discovery</a></h3>
<p>With this setup we can just reference a service by name, and use DNS to resolve it. The following shows how this works.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># check which IPs are registered for the backend-service
# called from outside the container
$ dig @nb-consul.local backend-service.service.consul +short
10.0.9.7
10.0.9.8
10.0.9.6

# If we do this from a container, we can do just this
docker exec -ti nb2/Frontend2 ping backend-service
PING backend-service.service.consul (10.0.9.8): 56 data bytes
64 bytes from 10.0.9.8: icmp_seq=0 ttl=64 time=0.809 ms
64 bytes from 10.0.9.8: icmp_seq=1 ttl=64 time=0.636 ms

</code></pre></div></div>

<p>Cool right? We can discover service, by just using DNS. That also means that integrating this in our existing applications is really easy, since we can just rely on basic DNS resolving. For example, in the frontend service we call the backend using this code:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>resp, err := http.Get("http://backend-service:8081")
if err != nil {
	// handle error
	fmt.Println(err)
} else {
	defer resp.Body.Close()
	body, _ := ioutil.ReadAll(resp.Body)
	w.Header().Set("Content-Type",resp.Header.Get("Content-Type"))
	w.Write(body)
}

</code></pre></div></div>

<p>This calls one of the backend services using DNS. We now also have some simple failover, since the DNS timetolive of Consul is set to 0. Applications might still do some caching, but it means that we already have some basic failover:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl -s backend-service:8081

        {"result" : {
          "servername" : "Server1",
          "querycount" : 778
          }
        }

# shutdown server 1 and do again, curl has a DNS cache of
# 1 minute, so you might need to wait a bit
$ curl -s backend-service:8081

        {"result" : {
          "servername" : "Server2",
          "querycount" : 770
          }
        }

$ curl -s backend-service:8081

        {"result" : {
          "servername" : "Server2",
          "querycount" : 771
          }
        }

</code></pre></div></div>

<p>Which of course also works for our frontend/golang application:</p>

<p><img src="assets/1548666470-67f82d6680eec9c0751f6b5c3daaefe6.png" width="700" alt="consul_3.png"></p>

<p>In the follow up to this article, we'll also show some more advanced failover, by introducing HAProxy as an intermediate for more advanced failover techniques.</p>
<h2><a href="#conclusions" name="conclusions">Conclusions</a></h2>
<p>That pretty much wraps it up for this first article. So in summary what have we done:</p>
<ol>
  <li>We've setup a simple architecture using 4 docker nodes. 1 for the consul server, and three for our services.</li>
  <li>The services register themselves with Consul on service startup.</li>
  <li>We don't need to explicitly do something to enable service discovery. We can use standard DNS to lookup a service.</li>
  <li>Consul uses a TTL of 0 for DNS, and returns the available services using roundrobin. As you've seen, you can already use this for basic failover, when a DNS lookup fails.</li>
</ol>
<p>Keep tuned for the follow up article somewhere in the coming weeks.</p>

        
      </section>

      <footer class="page__meta">
        
        


        
          <p class="page__date"><strong><svg class="svg-inline--fa fa-calendar-alt fa-w-14 fa-fw" aria-hidden="true" data-prefix="fas" data-icon="calendar-alt" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M436 160H12c-6.6 0-12-5.4-12-12v-36c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48v36c0 6.6-5.4 12-12 12zM12 192h424c6.6 0 12 5.4 12 12v260c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V204c0-6.6 5.4-12 12-12zm116 204c0-6.6-5.4-12-12-12H76c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40zm0-128c0-6.6-5.4-12-12-12H76c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40zm128 128c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40zm0-128c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40zm128 128c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40zm0-128c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40z"></path></svg><!-- <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> --> Updated:</strong> <time datetime="2016-04-23T00:00:00+02:00">April 23, 2016</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=josdirksen&amp;text=Service+Discovery+with+Docker+and+Consul%3A+part+1%20http%3A%2F%2Fwww.smartjava.org%2Fcontent%2Fservice-discovery-docker-and-consul-part-1%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><svg class="svg-inline--fa fa-twitter fa-w-16 fa-fw" aria-hidden="true" data-prefix="fab" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg><!-- <i class="fab fa-fw fa-twitter" aria-hidden="true"></i> --><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.smartjava.org%2Fcontent%2Fservice-discovery-docker-and-consul-part-1%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><svg class="svg-inline--fa fa-facebook fa-w-14 fa-fw" aria-hidden="true" data-prefix="fab" data-icon="facebook" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M448 56.7v398.5c0 13.7-11.1 24.7-24.7 24.7H309.1V306.5h58.2l8.7-67.6h-67v-43.2c0-19.6 5.4-32.9 33.5-32.9h35.8v-60.5c-6.2-.8-27.4-2.7-52.2-2.7-51.6 0-87 31.5-87 89.4v49.9h-58.4v67.6h58.4V480H24.7C11.1 480 0 468.9 0 455.3V56.7C0 43.1 11.1 32 24.7 32h398.5c13.7 0 24.8 11.1 24.8 24.7z"></path></svg><!-- <i class="fab fa-fw fa-facebook" aria-hidden="true"></i> --><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2Fwww.smartjava.org%2Fcontent%2Fservice-discovery-docker-and-consul-part-1%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><svg class="svg-inline--fa fa-google-plus fa-w-16 fa-fw" aria-hidden="true" data-prefix="fab" data-icon="google-plus" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M248 8C111.1 8 0 119.1 0 256s111.1 248 248 248 248-111.1 248-248S384.9 8 248 8zm-70.7 372c-68.8 0-124-55.5-124-124s55.2-124 124-124c31.3 0 60.1 11 83 32.3l-33.6 32.6c-13.2-12.9-31.3-19.1-49.4-19.1-42.9 0-77.2 35.5-77.2 78.1s34.2 78.1 77.2 78.1c32.6 0 64.9-19.1 70.1-53.3h-70.1v-42.6h116.9c1.3 6.8 1.9 13.6 1.9 20.7 0 70.8-47.5 121.2-118.8 121.2zm230.2-106.2v35.5H372v-35.5h-35.5v-35.5H372v-35.5h35.5v35.5h35.2v35.5h-35.2z"></path></svg><!-- <i class="fab fa-fw fa-google-plus" aria-hidden="true"></i> --><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3A%2F%2Fwww.smartjava.org%2Fcontent%2Fservice-discovery-docker-and-consul-part-1%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><svg class="svg-inline--fa fa-linkedin fa-w-14 fa-fw" aria-hidden="true" data-prefix="fab" data-icon="linkedin" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg><!-- <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> --><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="http://www.smartjava.org/content/presentation-service-discovery-microservice-architecture/" class="pagination--pager" title="Presentation: Service discovery in a microservice architecture
">Previous</a>
    
    
      <a href="http://www.smartjava.org/content/scalaz-features-everyday-usage-part-1-typeclasses-and-scala-extensions/" class="pagination--pager" title="Scalaz features for everyday usage part 1: Typeclasses and Scala extensions
">Next</a>
    
  </nav>

    </div>

    
  </article></DIV></DIV>
      
        <hr />
        <!-- clipping information -->
        <div class="clipping-information">
          <label>Original url: <a href="http://www.smartjava.org/content/service-discovery-docker-and-consul-part-1/#conclusions" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">Access</a></label><br />
          <label>Created at: 2019-01-28 17:07:50</label><br />
          <label>Category: default</label><br />
          <label>Tags: none</label>
        </div>
    </div>
  </body>
</html>